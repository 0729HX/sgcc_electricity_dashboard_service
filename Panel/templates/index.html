<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>SGCC 电力监控系统</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'PingFang SC', sans-serif; background: radial-gradient(circle at top, #1e293b 0, #020617 55%, #000 100%); color: #e5e7eb; }
        .number-font { font-family: 'JetBrains Mono', monospace; }
        .sync-card-height { height: 500px !important; }
        .table-wrapper { display: flex; flex-direction: column; height: 100%; }
        .scroll-area { flex-grow: 1; overflow-y: auto; padding-right: 4px; }
        .scroll-area::-webkit-scrollbar { width: 4px; }
        .scroll-area::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.7); border-radius: 10px; }
        .glass-card { background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.25), rgba(15, 23, 42, 0.9)); border-radius: 1.5rem; border: 1px solid rgba(148, 163, 184, 0.45); box-shadow: 0 18px 60px rgba(15, 23, 42, 0.9); backdrop-filter: blur(22px) saturate(140%); -webkit-backdrop-filter: blur(22px) saturate(140%); }
        .glass-soft { background: linear-gradient(135deg, rgba(51, 65, 85, 0.75), rgba(15, 23, 42, 0.9)); border-radius: 1rem; border: 1px solid rgba(71, 85, 105, 0.7); box-shadow: 0 10px 40px rgba(15, 23, 42, 0.8); backdrop-filter: blur(18px) saturate(130%); -webkit-backdrop-filter: blur(18px) saturate(130%); }
    </style>
{# 避免 Flask/Jinja 解析 Vue 模板语法 #}
</head>
<body class="p-6 lg:p-10 min-h-screen">
{% raw %}
    <div id="app" class="w-full space-y-8">
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="glass-card p-6 border-l-8 border-blue-500/80">
                <p class="text-slate-300 text-xs font-bold mb-1">账户余额</p>
                <div class="text-3xl font-black number-font text-blue-400">
                    ¥ {{ overview.balance }}
                </div>
            </div>
            <div class="glass-card p-6 border-l-8 border-emerald-500/80">
                <p class="text-slate-300 text-xs font-bold mb-1">
                    最新用电 ({{ overview.last_daily_date ? overview.last_daily_date.slice(5) : '' }})
                </p>
                <div class="text-3xl font-black number-font text-emerald-400">
                    {{ overview.last_daily_usage }} <span class="text-sm">kWh</span>
                </div>
            </div>
            <div class="glass-card p-6 border-l-8 border-orange-500/80">
                <p class="text-slate-300 text-xs font-bold mb-1">年度累计用电</p>
                <div class="text-3xl font-black number-font text-orange-400">
                    {{ overview.total_usage }} <span class="text-sm">kWh</span>
                </div>
            </div>
            <div class="glass-card p-6 border-l-8 border-indigo-500/80">
                <p class="text-slate-300 text-xs font-bold mb-1">年度总电费</p>
                <div class="text-3xl font-black number-font text-indigo-400">
                    ¥ {{ overview.total_charge }}
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-stretch">
            <div class="lg:col-span-8 glass-card p-8 sync-card-height flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black text-slate-50 flex items-center">
                        <span class="w-2.5 h-8 bg-blue-500 rounded-full mr-4"></span>用电趋势波动
                    </h2>
                    <div class="flex glass-soft p-1 rounded-xl">
                        <button @click="changeChartRange(7)" :class="chartRange===7?'bg-slate-900/70 shadow-sm text-sky-400':'text-slate-400'" class="px-6 py-2 rounded-lg text-sm font-bold transition-all">7天</button>
                        <button @click="changeChartRange(30)" :class="chartRange===30?'bg-slate-900/70 shadow-sm text-sky-400':'text-slate-400'" class="px-6 py-2 rounded-lg text-sm font-bold transition-all">30天</button>
                    </div>
                </div>
                <div id="dailyChart" class="flex-grow"></div>
            </div>

            <div class="lg:col-span-4 glass-card p-8 sync-card-height">
                <div class="table-wrapper">
                    <h2 class="text-xl font-bold text-slate-50 mb-6 flex items-center">
                        <span class="w-1.5 h-6 bg-blue-400 rounded-full mr-3"></span>每日用电明细
                    </h2>
                    <div class="flex justify-between px-4 pb-3 text-sm font-bold text-slate-400 border-b border-slate-700/60">
                        <span>日期</span>
                        <span>用量(kWh)</span>
                    </div>
                    <div class="scroll-area pt-2">
                        <div v-for="d in dailyData.slice().reverse()" :key="d.date" class="flex justify-between items-center py-3 px-4 mb-2 glass-soft hover:bg-slate-900/80 transition-colors">
                            <span class="font-bold text-slate-100">{{ d.date }}</span>
                            <span
                                class="font-black number-font"
                                :class="d.usage === maxDailyUsage ? 'text-red-400' : 'text-sky-400'"
                            >
                                {{ d.usage }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-stretch">
            <div class="lg:col-span-8 glass-card p-8 sync-card-height flex flex-col">
                <h2 class="text-2xl font-black text-slate-50 mb-6 flex items-center">
                    <span class="w-2.5 h-8 bg-emerald-400 rounded-full mr-4"></span>月度统计对比
                </h2>
                <div id="monthlyChart" class="flex-grow"></div>
            </div>

            <div class="lg:col-span-4 glass-card p-8 sync-card-height">
                <div class="table-wrapper">
                    <h2 class="text-xl font-bold text-slate-50 mb-6 flex items-center">
                        <span class="w-1.5 h-6 bg-emerald-400 rounded-full mr-3"></span>月度汇总清单
                    </h2>
                    <div class="flex justify-between px-4 pb-3 text-sm font-bold text-slate-400 border-b border-slate-700/60">
                        <span>月份</span>
                        <span class="text-right">用量(kWh) / 费用(元)</span>
                    </div>
                    <div class="scroll-area pt-2">
                        <div
                            v-for="m in monthlyData.slice().reverse()"
                            :key="m.month"
                            class="flex justify-between items-center py-3 px-4 mb-2 glass-soft hover:bg-slate-900/80 transition-colors"
                        >
                            <span class="font-bold text-slate-100">{{ m.month }}</span>
                            <span class="font-black number-font text-right">
                                <span
                                    :class="m.usage === maxMonthlyUsage ? 'text-red-400' : 'text-emerald-400'"
                                >
                                    {{ m.usage }}
                                </span>
                                <span
                                    class="text-xs mx-1 text-slate-400"
                                >
                                    /
                                </span>
                                <span :class="m.usage === maxMonthlyUsage ? 'text-red-400' : 'text-sky-400'">
                                    {{ m.charge }}
                                </span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, onMounted, ref } = Vue;
        const API_BASE = '';

        createApp({
            setup() {
                const overview = ref({
                    balance: 0,
                    last_daily_date: '',
                    last_daily_usage: 0,
                    total_usage: 0,
                    total_charge: 0
                });
                const chartRange = ref(30);
                const dailyData = ref([]);
                const monthlyData = ref([]);
                const maxDailyUsage = ref(0);
                const maxMonthlyUsage = ref(0);
                let dChart, mChart;

                const colorForValue = (v, min, max) => {
                    if (min === max) return '#38bdf8';
                    const ratio = (v - min) / (max - min || 1);
                    if (ratio <= 0.25) return '#22c55e';
                    if (ratio <= 0.5) return '#16a34a';
                    if (ratio <= 0.75) return '#facc15';
                    if (ratio <= 0.9) return '#f97316';
                    return '#ef4444';
                };

                const fetchData = async () => {
                    const resO = await fetch(`${API_BASE}/api/stats/overview`);
                    overview.value = await resO.json();

                    const resD = await fetch(`${API_BASE}/api/stats/daily?days=100`);
                    dailyData.value = await resD.json();
                    maxDailyUsage.value = dailyData.value.length
                        ? Math.max(...dailyData.value.map(i => i.usage))
                        : 0;
                    const resM = await fetch(`${API_BASE}/api/stats/monthly`);
                    monthlyData.value = await resM.json();
                    maxMonthlyUsage.value = monthlyData.value.length
                        ? Math.max(...monthlyData.value.map(i => i.usage))
                        : 0;
                    renderDailyChart();
                    renderMonthlyChart();
                };

                const renderDailyChart = () => {
                    const all = [...dailyData.value];
                    const n = chartRange.value;
                    const chartData = n >= all.length ? all : all.slice(all.length - n);
                    const values = chartData.map(i => i.usage);
                    const avg = values.length ? values.reduce((a, b) => a + b, 0) / values.length : 0;
                    const min = values.length ? Math.min(...values) : 0;
                    const max = values.length ? Math.max(...values) : 0;
                    dChart.setOption({
                        backgroundColor: 'transparent',
                        textStyle: { color: '#e5e7eb' },
                        animation: false,
                        tooltip: {
                            trigger: 'axis',
                            backgroundColor: 'rgba(15,23,42,0.95)',
                            borderColor: 'rgba(148,163,184,0.6)',
                            textStyle: { color: '#e5e7eb' }
                        },
                        grid: { left: '3%', right: '3%', top: '10%', bottom: '8%', containLabel: true },
                        xAxis: {
                            type: 'category',
                            data: chartData.map(i => i.date.slice(5)),
                            boundaryGap: false,
                            axisLine: { lineStyle: { color: '#64748b' } },
                            axisLabel: { color: '#cbd5f5' },
                            axisTick: { lineStyle: { color: '#475569' } }
                        },
                        yAxis: {
                            type: 'value',
                            splitLine: { lineStyle: { type: 'dashed', color: 'rgba(148,163,184,0.4)' } },
                            axisLine: { show: false },
                            axisLabel: { color: '#9ca3af' }
                        },
                        series: [{
                            data: chartData.map(i => i.usage),
                            type: 'line',
                            smooth: true,
                            symbol: 'circle',
                            symbolSize: 6,
                            animation: false,
                            itemStyle: {
                                color: params => colorForValue(params.data, min, max)
                            },
                            lineStyle: { width: 2, color: '#38bdf8' },
                            areaStyle: { color: 'rgba(56,189,248,0.18)' },
                            markLine: {
                                symbol: 'none',
                                lineStyle: { type: 'dashed', color: 'rgba(148,163,184,0.9)' },
                                label: {
                                    show: true,
                                    position: 'insideEndTop',
                                    formatter: '平均值: {c}',
                                    color: '#e5e7eb',
                                    backgroundColor: 'rgba(15,23,42,0.85)',
                                    padding: [4, 8],
                                    borderRadius: 6
                                },
                                data: [{ name: '平均值', yAxis: avg }]
                            }
                        }]
                    }, true);
                };

                const renderMonthlyChart = () => {
                    const mData = [...monthlyData.value];
                    const values = mData.map(i => i.usage);
                    const avg = values.length ? values.reduce((a, b) => a + b, 0) / values.length : 0;
                    const min = values.length ? Math.min(...values) : 0;
                    const max = values.length ? Math.max(...values) : 0;
                    mChart.setOption({
                        backgroundColor: 'transparent',
                        textStyle: { color: '#e5e7eb' },
                        tooltip: {
                            trigger: 'axis',
                            backgroundColor: 'rgba(15,23,42,0.95)',
                            borderColor: 'rgba(148,163,184,0.6)',
                            textStyle: { color: '#e5e7eb' }
                        },
                        grid: { left: '3%', right: '3%', top: '10%', bottom: '8%', containLabel: true },
                        xAxis: {
                            type: 'category',
                            data: mData.map(i => i.month),
                            axisLine: { lineStyle: { color: '#64748b' } },
                            axisLabel: { color: '#cbd5f5' },
                            axisTick: { lineStyle: { color: '#475569' } }
                        },
                        yAxis: {
                            type: 'value',
                            splitLine: { lineStyle: { type: 'dashed', color: 'rgba(148,163,184,0.4)' } },
                            axisLine: { show: false },
                            axisLabel: { color: '#9ca3af' }
                        },
                        series: [{
                            data: mData.map(i => i.usage),
                            type: 'bar',
                            barWidth: '40%',
                            itemStyle: {
                                color: params => colorForValue(params.data, min, max),
                                borderRadius: [10, 10, 0, 0],
                                shadowBlur: 16,
                                shadowColor: 'rgba(15,23,42,0.8)',
                                shadowOffsetY: 6
                            },
                            markLine: {
                                symbol: 'none',
                                lineStyle: { type: 'dashed', color: 'rgba(148,163,184,0.9)' },
                                label: {
                                    show: true,
                                    position: 'insideEndTop',
                                    formatter: '平均值: {c}',
                                    color: '#e5e7eb',
                                    backgroundColor: 'rgba(15,23,42,0.85)',
                                    padding: [4, 8],
                                    borderRadius: 6
                                },
                                data: [{ name: '平均值', yAxis: avg }]
                            }
                        }]
                    });
                };

                onMounted(() => {
                    dChart = echarts.init(document.getElementById('dailyChart'));
                    mChart = echarts.init(document.getElementById('monthlyChart'));
                    fetchData();
                    window.onresize = () => { dChart.resize(); mChart.resize(); };
                });

                return {
                    overview,
                    chartRange,
                    dailyData,
                    monthlyData,
                    maxDailyUsage,
                    maxMonthlyUsage,
                    changeChartRange: (r) => { chartRange.value = r; renderDailyChart(); }
                };
            }
        }).mount('#app');
    </script>
{% endraw %}
</body>
</html>
